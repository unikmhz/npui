/*
 * Extensible 1.6.0-rc.1
 * Copyright(c) 2010-2013 Extensible, LLC
 * licensing@ext.ensible.com
 * http://ext.ensible.com
 */
Ext.define("Extensible.form.recurrence.Rule",{config:{dateValueFormat:"Ymd\\THis\\Z",rule:null,startDate:null,frequency:null,count:null,until:null,interval:1,byDay:null,byDayWeekdays:null,byMonthDay:null,byMonth:null,strings:{dayNamesShort:{SU:"Sun",MO:"Mon",TU:"Tue",WE:"Wed",TH:"Thu",FR:"Fri",SA:"Sat"},dayNamesShortByIndex:{0:"Sun",1:"Mon",2:"Tue",3:"Wed",4:"Thu",5:"Fri",6:"Sat"},dayNamesLong:{SU:"Sunday",MO:"Monday",TU:"Tuesday",WE:"Wednesday",TH:"Thursday",FR:"Friday",SA:"Saturday"},ordinals:{1:"first",2:"second",3:"third",4:"fourth",5:"fifth",6:"sixth"},frequency:{none:"Does not repeat",daily:"Daily",weekly:"Weekly",weekdays:"Every weekday (Mon-Fri)",monthly:"Monthly",yearly:"Yearly"},every:"Every",days:"days",weeks:"weeks",weekdays:"weekdays",months:"months",years:"years",time:"time",times:"times",until:"until",untilFormat:"M j, Y",and:"and",on:"on",onDay:"on day",onDayPostfix:"",onThe:"on the",onTheLast:"on the last",onTheLastDay:"on the last day",of:"of",monthFormat:"F",monthDayFormat:"F j"}},byDayNames:["SU","MO","TU","WE","TH","FR","SA"],constructor:function(a){return this.initConfig(a)},init:function(){var a=this;a.startDate=null;a.frequency=null;a.count=null;a.until=null;a.interval=1;a.byDay=null;a.byDayWeekdays=null;a.byDayNthWeekday=null;a.byMonthDay=null;a.byMonth=null},applyStartDate:function(a){this.startDate=new Date(a)},applyFrequency:function(a){this.init();this.frequency=a},applyCount:function(a){this.until=null;this.count=a},applyUntil:function(a){this.count=this.until=null;if(Ext.isDate(a)){this.until=a}else{if(typeof a==="string"){this.until=this.parseDate(a)}}},parseDate:function(d,b){b=b||{};try{var a=Ext.Date.parse(d,b.format||this.dateValueFormat,b.strict);if(a){return a}}catch(c){}return b.defaultValue||new Date()},formatDate:function(a){return Ext.Date.format(a,this.dateValueFormat)},applyByDay:function(a){var b=this;b.byMonthDay=null;b.byDayWeekdays=null;b.byDayNthWeekday=null;if(typeof a==="string"){b.byDay=a;var c=parseInt(a,10);if(Ext.isNumber(c)){if(c===-1){b.byDayNthWeekday={number:c,weekday:a.substr(2,2)}}else{b.byDayNthWeekday={number:c,weekday:a.substr(1,2)}}}else{b.byDayWeekdays=a.split(",")}}else{if(Array.isArray(a)){b.byDay=a.join(",");b.byDayWeekdays=a}else{if(Ext.isObject(a)){b.byDay=a.number+a.weekday;b.byDayNthWeekday=a}}}},getByDayNthWeekday:function(){return this.byDayNthWeekday},applyByMonthDay:function(a){this.byDay=null;this.byDayWeekdays=null;this.byDayNthWeekday=null;this.byMonthDay=a},getRule:function(){var b=[],a=this;if(!a.frequency){return""}b.push("FREQ="+a.frequency);if(a.interval!==1){b.push("INTERVAL="+a.interval)}if(a.byDay){b.push("BYDAY="+a.byDay)}if(a.byMonthDay){b.push("BYMONTHDAY="+a.byMonthDay)}if(a.byMonth){b.push("BYMONTH="+a.byMonth)}if(a.count){b.push("COUNT="+a.count)}if(a.until){b.push("UNTIL="+Ext.Date.format(a.until,a.dateValueFormat))}return b.join(";")+";"},applyRule:function(f){var b,a,g,c,d=0,e=this;if(!f){this.init();return}b=f.split(";");a=b.length;for(;d<a;d++){g=b[d].split("=");if(g[0]==="FREQ"){e.setFrequency(g[1]);break}}for(d=0;d<a;d++){g=b[d].split("=");c=g[1];switch(g[0]){case"INTERVAL":e.setInterval(parseInt(c,10));break;case"COUNT":e.setCount(parseInt(c,10));break;case"UNTIL":e.setUntil(c);break;case"BYDAY":e.setByDay(c);break;case"BYMONTHDAY":e.setByMonthDay(parseInt(c,10));break;case"BYMONTH":e.setByMonth(parseInt(c,10));break}}},getDescription:function(a){var b=this,d=[],c=b.frequency?Ext.String.capitalize(b.frequency.toLowerCase()):"";a=a||this.startDate;if(c&&b["getDescription"+c]){b["getDescription"+c](d,a)}b.getDescriptionCount(d,a);b.getDescriptionUntil(d,a);return d.join("")},getDescriptionDaily:function(d,b){var c=this,a=c.strings;if(c.interval===1){d.push(a.frequency.daily)}else{d.push(a.every," ",c.interval," ",a.days)}},getDescriptionWeekly:function(f,c){var e=this,b=e.strings;if(e.interval===1){f.push(b.frequency.weekly)}else{f.push(b.every," ",e.interval," ",b.weeks)}if(e.byDayWeekdays){var a=e.byDayWeekdays.length;f.push(" ",b.on," ");for(var d=0;d<a;d++){if(d>0&&d<a-1){f.push(", ")}else{if(a>1&&d===a-1){f.push(" ",b.and," ")}}if(a>2){f.push(b.dayNamesShort[e.byDayWeekdays[d]])}else{f.push(b.dayNamesLong[e.byDayWeekdays[d]])}}}else{if(c){f.push(" ",b.on," ",b.dayNamesLong[e.byDayNames[c.getDay()]])}}},getDescriptionWeekdays:function(b,a){if(this.interval===1){b.push(this.strings.frequency.weekdays)}else{b.push(this.strings.every," ",this.interval," ",this.strings.weekdays)}},getDescriptionMonthly:function(d,b){var c=this,a=c.strings;if(c.interval===1){d.push(a.frequency.monthly)}else{d.push(a.every," ",c.interval," ",a.months)}if(c.byMonthDay>0){d.push(" "+a.onDay+" "+c.byMonthDay+a.onDayPostfix)}else{if(c.byMonthDay===-1){d.push(" "+a.onTheLastDay)}else{if(c.byDayNthWeekday){if(c.byDayNthWeekday.number>0){d.push(" ",a.onThe," ",a.ordinals[c.byDayNthWeekday.number]," ",a.dayNamesLong[c.byDayNthWeekday.weekday])}else{d.push(" "+a.onTheLast+" "+a.dayNamesLong[c.byDayNthWeekday.weekday])}}}}},getDescriptionYearly:function(d,b){var c=this,a=c.strings;if(c.interval===1){d.push(a.frequency.yearly)}else{d.push(a.every," ",c.interval," ",a.years)}if(!b){return}if(c.byMonthDay===-1){d.push(" ",a.onTheLastDay," ",a.of," ",Ext.Date.format(b,a.monthFormat))}else{if(c.byDayNthWeekday){if(c.byDayNthWeekday.number>0){d.push(" ",a.onThe," ",a.ordinals[c.byDayNthWeekday.number]," ",a.dayNamesLong[c.byDayNthWeekday.weekday]," ",a.of," ",Ext.Date.format(b,a.monthFormat))}else{d.push(" ",a.onTheLast," ",a.dayNamesLong[c.byDayNthWeekday.weekday]," ",a.of," ",Ext.Date.format(b,a.monthFormat))}}else{d.push(" ",a.on," ",Ext.Date.format(b,a.monthDayFormat))}}},getDescriptionCount:function(b,a){if(this.count){b.push(", ",this.count," ",(this.count===1?this.strings.time:this.strings.times))}},getDescriptionUntil:function(b,a){if(this.until){b.push(", ",this.strings.until," ",Ext.Date.format(this.until,this.strings.untilFormat))}}});Ext.define("Extensible.form.recurrence.Parser",{extend:"Extensible.form.recurrence.Rule",singleton:true});Ext.define("Extensible.form.recurrence.AbstractOption",{extend:"Ext.form.FieldContainer",requires:["Extensible.form.recurrence.Rule"],mixins:{field:"Ext.form.field.Field"},layout:"hbox",defaults:{margins:"0 5 0 0"},rrule:undefined,startDate:undefined,startDay:0,maxEndDate:new Date("12/31/9999"),key:undefined,optionDelimiter:";",initComponent:function(){var a=this;a.addEvents("change");a.initRRule();a.items=a.getItemConfigs();a.callParent(arguments);a.initRefs();a.initField()},initRRule:function(){var a=this;a.rrule=a.rrule||Ext.create("Extensible.form.recurrence.Rule");a.startDate=a.startDate||a.rrule.startDate||Extensible.Date.today();if(!a.rrule.startDate){a.rrule.setStartDate(a.startDate)}},afterRender:function(){this.callParent(arguments);this.updateLabel()},initRefs:Ext.emptyFn,setFrequency:function(a){this.frequency=a},setStartDate:function(a){this.startDate=a;return this},getStartDate:function(){return this.startDate||Extensible.Date.today()},getDefaultValue:function(){return""},preSetValue:function(b,a){var c=this;if(!b){b=c.getDefaultValue()}if(!a){c.on("afterrender",function(){c.setValue(b)},c,{single:true});return false}c.value=b;return true}});Ext.define("Extensible.form.recurrence.option.Duration",{extend:"Extensible.form.recurrence.AbstractOption",alias:"widget.extensible.recurrence-duration",requires:["Ext.form.Label","Ext.form.field.ComboBox","Ext.form.field.Number","Ext.form.field.Date"],minOccurrences:1,maxOccurrences:999,defaultEndDateOffset:5,minDateOffset:1,endDateWidth:120,strings:{andContinuing:"and continuing",occurrences:"occurrences",forever:"forever",forText:"for",until:"until"},cls:"extensible-recur-duration",getItemConfigs:function(){var a=this;return[a.getContinuingLabelConfig(),a.getDurationComboConfig(),a.getDurationDateFieldConfig(),a.getDurationNumberFieldConfig(),a.getOccurrencesLabelConfig()]},getContinuingLabelConfig:function(){return{xtype:"label",text:this.strings.andContinuing}},getDurationComboConfig:function(){var a=this;return{xtype:"combo",itemId:a.id+"-duration-combo",mode:"local",width:85,triggerAction:"all",forceSelection:true,value:a.strings.forever,store:[a.strings.forever,a.strings.forText,a.strings.until],listeners:{change:Ext.bind(a.onComboChange,a)}}},getDurationDateFieldConfig:function(){var b=this,a=b.getStartDate();return{xtype:"datefield",itemId:b.id+"-duration-date",showToday:false,width:b.endDateWidth,format:b.endDateFormat||Ext.form.field.Date.prototype.format,startDay:this.startDay,maxValue:b.maxEndDate,allowBlank:false,hidden:true,minValue:Ext.Date.add(a,Ext.Date.DAY,b.minDateOffset),value:b.getDefaultEndDate(a),listeners:{change:Ext.bind(b.onEndDateChange,b)}}},getDurationNumberFieldConfig:function(){var a=this;return{xtype:"numberfield",itemId:a.id+"-duration-num",value:5,width:55,minValue:a.minOccurrences,maxValue:a.maxOccurrences,allowBlank:false,hidden:true,listeners:{change:Ext.bind(a.onOccurrenceCountChange,a)}}},getOccurrencesLabelConfig:function(){return{xtype:"label",itemId:this.id+"-duration-num-label",text:this.strings.occurrences,hidden:true}},initRefs:function(){var a=this;a.untilCombo=a.down("#"+a.id+"-duration-combo");a.untilDateField=a.down("#"+a.id+"-duration-date");a.untilNumberField=a.down("#"+a.id+"-duration-num");a.untilNumberLabel=a.down("#"+a.id+"-duration-num-label")},onComboChange:function(b,a){this.toggleFields(a);this.checkChange()},toggleFields:function(a){var b=this;b.untilCombo.setValue(a);if(a===b.strings.until){if(!b.untilDateField.getValue()){b.initUntilDate()}b.untilDateField.show()}else{b.untilDateField.hide();b.untilDateIsSet=false}if(a===b.strings.forText){b.untilNumberField.show();b.untilNumberLabel.show()}else{b.untilNumberField.hide();b.untilNumberLabel.hide()}},onOccurrenceCountChange:function(c,b,a){this.checkChange()},onEndDateChange:function(c,b,a){this.checkChange()},setStartDate:function(b){var a=this,c=a.getValue();if(b.getTime()!==a.startDate.getTime()){a.callParent(arguments);a.untilDateField.setMinValue(b);if(!c||a.untilDateField.getValue()<b){a.initUntilDate(b)}}return a},setFrequency:function(){this.callParent(arguments);this.initUntilDate();return this},initUntilDate:function(a){if(!this.untilDateIsSet){this.untilDateIsSet=true;var b=this.getDefaultEndDate(a||this.getStartDate());this.untilDateField.setValue(b)}return this},getDefaultEndDate:function(a){var b={},c;switch(this.frequency){case"WEEKLY":case"WEEKDAYS":c="weeks";break;case"MONTHLY":c="months";break;case"YEARLY":c="years";break;default:c="days"}b[c]=this.defaultEndDateOffset;return Extensible.Date.add(a,b)},getValue:function(){var a=this;if(a.untilCombo){if(a.untilNumberField.isVisible()){return"COUNT="+a.untilNumberField.getValue()}if(a.untilDateField.isVisible()){return"UNTIL="+a.rrule.formatDate(this.adjustUntilDateValue(a.untilDateField.getValue()))}}return""},adjustUntilDateValue:function(a){return Extensible.Date.add(a,{days:1,seconds:-1})},setValue:function(a){var c=this;if(!c.preSetValue(a,c.untilCombo)){return c}if(!a){c.toggleFields(c.strings.forever);return c}var b=Ext.isArray(a)?a:a.split(c.optionDelimiter),e=false,d;Ext.each(b,function(f){d=f.split("=");if(d[0]==="COUNT"){c.untilNumberField.setValue(d[1]);c.toggleFields(c.strings.forText);e=true;return}if(d[0]==="UNTIL"){c.untilDateField.setValue(c.rrule.parseDate(d[1]));c.untilDateField.validate();c.toggleFields(c.strings.until);e=true;return}},c);if(!e){c.toggleFields(c.strings.forever)}return c}});Ext.define("Extensible.form.recurrence.option.Interval",{extend:"Extensible.form.recurrence.AbstractOption",alias:"widget.extensible.recurrence-interval",dateLabelFormat:"l, F j",unit:"day",minValue:1,maxValue:999,startDateWidth:120,strings:{repeatEvery:"Repeat every",beginning:"beginning",day:"day",days:"days",week:"week",weeks:"weeks",month:"month",months:"months",year:"year",years:"years"},cls:"extensible-recur-interval",initComponent:function(){this.addEvents("startchange");this.callParent(arguments)},getItemConfigs:function(){return[this.getRepeatEveryLabelConfig(),this.getIntervalComboConfig(),this.getBeginDateLabelConfig(),this.getBeginDateFieldConfig()]},getRepeatEveryLabelConfig:function(){return{xtype:"label",text:this.strings.repeatEvery}},getIntervalComboConfig:function(){var a=this;return{xtype:"numberfield",itemId:a.id+"-interval",value:1,width:55,minValue:a.minValue,maxValue:a.maxValue,allowBlank:false,enableKeyEvents:true,listeners:{change:Ext.bind(a.onIntervalChange,a)}}},getBeginDateLabelConfig:function(){return{xtype:"label",itemId:this.id+"-date-label"}},getBeginDateFieldConfig:function(){var b=this,a=b.getStartDate();return{xtype:"datefield",itemId:b.id+"-start-date",width:b.startDateWidth,startDay:this.startDay,maxValue:b.maxEndDate,allowBlank:false,value:a,listeners:{change:Ext.bind(b.onStartDateChange,b)}}},initRefs:function(){var a=this;a.intervalField=a.down("#"+a.id+"-interval");a.dateLabel=a.down("#"+a.id+"-date-label");a.startDateField=a.down("#"+a.id+"-start-date")},onIntervalChange:function(c,b,a){this.checkChange();this.updateLabel()},onStartDateChange:function(c,b,a){this.checkChange();this.fireEvent("startchange",this,b,a)},getValue:function(){if(this.intervalField){return"INTERVAL="+this.intervalField.getValue()}return""},setValue:function(a){var c=this;if(!c.preSetValue(a,c.intervalField)){return c}if(!a){c.intervalField.setValue(c.minValue);return c}var b=Ext.isArray(a)?a:a.split(c.optionDelimiter),d;Ext.each(b,function(e){d=e.split("=");if(d[0]==="INTERVAL"){c.intervalField.setValue(d[1]);c.updateLabel();return}},c);return c},setStartDate:function(a){this.startDate=a;this.startDateField.setValue(a);return this},setUnit:function(a){this.unit=a;this.updateLabel();return this},updateLabel:function(c){var b=this;if(b.intervalField){var a=b.intervalField.getValue()===1?"":"s";b.unit=c?c.toLowerCase():b.unit||"day";if(b.dateLabel){b.dateLabel.update(b.strings[b.unit+a]+" "+b.strings.beginning)}}return b}});Ext.define("Extensible.form.recurrence.option.Monthly",{extend:"Extensible.form.recurrence.AbstractOption",alias:"widget.extensible.recurrence-monthly",requires:["Ext.form.field.ComboBox","Extensible.lang.Number"],cls:"extensible-recur-monthly",nthComboWidth:150,strings:{onThe:"on the",ofEach:"of each",inText:"in",day:"day",month:"month",year:"year",last:"last",lastDay:"last day",monthDayDateFormat:"jS",nthWeekdayDateFormat:"S"},afterRender:function(){this.callParent(arguments);this.initNthCombo()},getItemConfigs:function(){return[this.getOnTheLabelConfig(),this.getNthComboConfig(),this.getOfEachLabelConfig()]},getOnTheLabelConfig:function(){return{xtype:"label",text:this.strings.onThe}},getNthComboConfig:function(){return{xtype:"combobox",itemId:this.id+"-nth-combo",queryMode:"local",width:this.nthComboWidth,triggerAction:"all",forceSelection:true,displayField:"text",valueField:"value",store:Ext.create("Ext.data.ArrayStore",{fields:["text","value"],idIndex:0,data:[]}),listeners:{change:Ext.bind(this.onComboChange,this)}}},getPeriodString:function(){return this.strings.month},getOfEachLabelConfig:function(){return{xtype:"label",text:this.strings.ofEach+" "+this.getPeriodString()}},initRefs:function(){this.nthCombo=this.down("#"+this.id+"-nth-combo")},onComboChange:function(b,a){this.checkChange()},setStartDate:function(a){if(a.getTime()!==this.startDate.getTime()){this.callParent(arguments);this.initNthCombo()}return this},initNthCombo:function(){if(!this.rendered){return}var k=this,f=k.nthCombo,n=f.store,d=k.getStartDate(),p=Ext.Date.getLastDateOfMonth(d).getDate(),j=Ext.Date.format(d,k.strings.monthDayDateFormat)+" "+k.strings.day,e=d.getDate(),a=Math.ceil(e/7),o=Extensible.form.recurrence.Parser.byDayNames[d.getDay()],g=new Date(2000,0,a),c=a+Ext.Date.format(g,k.strings.nthWeekdayDateFormat)+Ext.Date.format(d," l"),l=k.isYearly?" "+k.strings.inText+" "+Ext.Date.format(d,"F"):"",h=k.isYearly?"BYMONTH="+Ext.Date.format(d,"n"):"",b=k.isYearly?k.optionDelimiter:"",i=[[j+l,k.isYearly?h:"BYMONTHDAY="+e],[c+l,h+b+"BYDAY="+a+o]],m=n.find("value",f.getValue());if(p-e<7){i.push([k.strings.last+" "+Ext.Date.format(d,"l")+l,h+b+"BYDAY=-1"+o])}if(p===e){i.push([k.strings.lastDay+l,h+b+"BYMONTHDAY=-1"])}n.removeAll();f.clearValue();n.loadData(i);if(m>i.length-1){m=i.length-1}f.setValue(n.getAt(m>-1?m:0).data.value);return k},getValue:function(){var a=this;if(a.nthCombo){return a.nthCombo.getValue()}return""},setValue:function(c){var e=this;if(!e.preSetValue(c,e.nthCombo)){return e}if(!c){var a=e.nthCombo.store.getAt(0);if(a){e.nthCombo.setValue(a.data.value)}return e}var d=Ext.isArray(c)?c:c.split(e.optionDelimiter),f,b=[];Ext.each(d,function(g){f=g.split("=");if(f[0]==="BYMONTH"){b.unshift(g)}if(f[0]==="BYMONTHDAY"||f[0]==="BYDAY"){b.push(g)}},e);if(b.length){e.nthCombo.setValue(b.join(e.optionDelimiter))}return e}});Ext.define("Extensible.form.recurrence.option.Weekly",{extend:"Extensible.form.recurrence.AbstractOption",alias:"widget.extensible.recurrence-weekly",requires:["Ext.form.field.Checkbox","Ext.form.CheckboxGroup","Extensible.form.recurrence.Parser"],startDay:0,dayValueDelimiter:",",cls:"extensible-recur-weekly",strings:{on:"on"},getCheckboxGroupItems:function(){var d=Extensible.form.recurrence.Parser.byDayNames,a=Extensible.form.recurrence.Parser.strings.dayNamesShortByIndex,c=[],b=this.startDay;for(var e=0;e<7;e++){c[e]={boxLabel:a[b],name:d[b],id:this.id+"-"+d[b]};b=b===6?0:b+1}return c},getItemConfigs:function(){var a=this.id;return[{xtype:"label",text:this.strings.on+":"},{xtype:"checkboxgroup",itemId:a+"-days",flex:1,items:this.getCheckboxGroupItems(),listeners:{change:Ext.bind(this.onSelectionChange,this)}}]},initValue:function(){this.callParent(arguments);if(!this.value){this.selectByDate()}},initRefs:function(){this.daysCheckboxGroup=this.down("#"+this.id+"-days")},onSelectionChange:function(c,b,a){this.checkChange();this.updateLabel()},selectByDate:function(b){var a=Ext.Date.format(b||this.getStartDate(),"D").substring(0,2).toUpperCase();this.setValue("BYDAY="+a)},clearValue:function(){this.value=undefined;if(this.daysCheckboxGroup){this.daysCheckboxGroup.setValue({SU:0,MO:0,TU:0,WE:0,TH:0,FR:0,SA:0})}},getValue:function(){var a=this;if(a.daysCheckboxGroup){var c=a.daysCheckboxGroup.getValue(),d=[],b;for(b in c){if(c.hasOwnProperty(b)){d.push(b)}}return d.length>0?"BYDAY="+d.join(a.dayValueDelimiter):""}return""},setValue:function(a){var c=this;if(!c.preSetValue(a,c.daysCheckboxGroup)){return c}c.daysCheckboxGroup.setValue(null);if(!a){return c}var b=Ext.isArray(a)?a:a.split(c.optionDelimiter),e={},d,f;Ext.each(b,function(g){d=g.split("=");if(d[0]==="BYDAY"){f=d[1].split(c.dayValueDelimiter);Ext.each(f,function(h){e[h]=true},c);c.daysCheckboxGroup.setValue(e);return}},c);return c}});Ext.define("Extensible.form.recurrence.option.Yearly",{extend:"Extensible.form.recurrence.option.Monthly",alias:"widget.extensible.recurrence-yearly",cls:"extensible-recur-yearly",nthComboWidth:200,isYearly:true,getPeriodString:function(){return this.strings.year}});Ext.define("Extensible.form.recurrence.FrequencyCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.extensible.recurrence-frequency",requires:["Ext.data.ArrayStore","Extensible.form.recurrence.Parser"],fieldLabel:"Repeats",queryMode:"local",triggerAction:"all",forceSelection:true,displayField:"pattern",valueField:"id",cls:"extensible-recur-frequency",initComponent:function(){var a=this;a.addEvents("frequencychange");var b=Extensible.form.recurrence.Parser.strings.frequency;a.frequencyOptions=a.frequencyOptions||[["NONE",b.none],["DAILY",b.daily],["WEEKDAYS",b.weekdays],["WEEKLY",b.weekly],["MONTHLY",b.monthly],["YEARLY",b.yearly]];a.store=a.store||Ext.create("Ext.data.ArrayStore",{fields:["id","pattern"],idIndex:0,data:a.frequencyOptions});a.on("select",a.onSelect,a);a.callParent(arguments)},onSelect:function(b,a){this.fireEvent("frequencychange",a[0].data.id)}});Ext.define("Extensible.form.recurrence.Fieldset",{extend:"Ext.form.FieldContainer",alias:"widget.extensible.recurrencefield",mixins:{field:"Ext.form.field.Field"},requires:["Ext.form.Label","Extensible.form.recurrence.Rule","Extensible.form.recurrence.FrequencyCombo","Extensible.form.recurrence.option.Interval","Extensible.form.recurrence.option.Weekly","Extensible.form.recurrence.option.Monthly","Extensible.form.recurrence.option.Yearly","Extensible.form.recurrence.option.Duration"],rrule:undefined,startDate:undefined,startDay:0,options:["daily","weekly","weekdays","monthly","yearly"],displayStyle:"field",fieldLabel:"Repeats",fieldContainerWidth:400,monitorChanges:true,cls:"extensible-recur-field",frequencyWidth:null,layout:"anchor",defaults:{anchor:"100%"},initComponent:function(){var a=this;if(!a.height||a.displayStyle==="field"){delete a.height;a.autoHeight=true}this.addEvents("startchange");a.initRRule();a.items=[{xtype:"extensible.recurrence-frequency",hideLabel:true,width:this.frequencyWidth,itemId:this.id+"-frequency",listeners:{frequencychange:{fn:this.onFrequencyChange,scope:this}}},{xtype:"container",itemId:this.id+"-inner-ct",cls:"extensible-recur-inner-ct",autoHeight:true,layout:"anchor",hideMode:"offsets",hidden:true,width:this.fieldContainerWidth,defaults:{hidden:true,rrule:a.rrule},items:[{xtype:"extensible.recurrence-interval",itemId:this.id+"-interval"},{xtype:"extensible.recurrence-weekly",itemId:this.id+"-weekly",startDay:this.startDay},{xtype:"extensible.recurrence-monthly",itemId:this.id+"-monthly"},{xtype:"extensible.recurrence-yearly",itemId:this.id+"-yearly"},{xtype:"extensible.recurrence-duration",itemId:this.id+"-duration",startDay:this.startDay}]}];a.callParent(arguments);a.initField()},initRRule:function(){var a=this;a.rrule=a.rrule||Ext.create("Extensible.form.recurrence.Rule");a.startDate=a.startDate||a.rrule.startDate||Extensible.Date.today();if(!a.rrule.startDate){a.rrule.setStartDate(a.startDate)}},afterRender:function(){this.callParent(arguments);this.initRefs()},initRefs:function(){var a=this,b=a.id;a.innerContainer=a.down("#"+b+"-inner-ct");a.frequencyCombo=a.down("#"+b+"-frequency");a.intervalField=a.down("#"+b+"-interval");a.weeklyField=a.down("#"+b+"-weekly");a.monthlyField=a.down("#"+b+"-monthly");a.yearlyField=a.down("#"+b+"-yearly");a.durationField=a.down("#"+b+"-duration");a.initChangeEvents()},initChangeEvents:function(){var a=this;a.intervalField.on("startchange",a.onStartDateChange,a);a.intervalField.on("change",a.onChange,a);a.weeklyField.on("change",a.onChange,a);a.monthlyField.on("change",a.onChange,a);a.yearlyField.on("change",a.onChange,a);a.durationField.on("change",a.onChange,a)},onStartDateChange:function(b,a,c){this.fireEvent("startchange",this,a,c)},onChange:function(){this.fireEvent("change",this,this.getValue())},onFrequencyChange:function(a){this.setFrequency(a);this.onChange()},initValue:function(){var a=this;a.originalValue=a.lastValue=a.value;a.suspendCheckChange++;a.setStartDate(a.startDate);if(a.value!==undefined){a.setValue(a.value)}else{if(a.frequency!==undefined){a.setValue("FREQ="+a.frequency)}else{a.setValue("")}}a.suspendCheckChange--;Ext.defer(a.doLayout,1,a);a.onChange()},setStartDate:function(b){var a=this;a.startDate=b;if(a.innerContainer){a.innerContainer.items.each(function(c){if(c.setStartDate){c.setStartDate(b)}})}else{a.on("afterrender",function(){a.setStartDate(b)},a,{single:true})}return a},getStartDate:function(){return this.startDate},isRecurring:function(){return this.getValue()!==""},getValue:function(){if(!this.innerContainer){return this.value}if(this.frequency==="NONE"){return""}var a,b;if(this.frequency==="WEEKDAYS"){a=["FREQ=WEEKLY","BYDAY=MO,TU,WE,TH,FR"]}else{a=["FREQ="+this.frequency]}this.innerContainer.items.each(function(c){if(c.isVisible()&&c.getValue){b=c.getValue();if(this.includeItemValue(b)){a.push(b)}}},this);return a.length>1?a.join(";"):a[0]},includeItemValue:function(b){if(b){if(b==="INTERVAL=1"){return false}var a=Ext.Date.format(this.startDate,"D").substring(0,2).toUpperCase();if(b===("BYDAY="+a)){return false}return true}return false},getDescription:function(){return this.rrule.setRule(this.getValue()).getDescription()},setValue:function(b){var a=this;a.value=(!b||b==="NONE"?"":b);if(!a.frequencyCombo||!a.innerContainer){a.on("afterrender",function(){a.setValue(b)},a,{single:true});return}var c=a.value.split(";");if(a.value===""){a.setFrequency("NONE")}else{Ext.each(c,function(d){if(d.indexOf("FREQ")>-1){var e=d.split("=")[1];a.setFrequency(e);a.checkChange();return}},a)}a.innerContainer.items.each(function(d){if(d.setValue){d.setValue(a.value)}});a.checkChange();return a},setFrequency:function(b){var a=this;a.frequency=b;if(a.frequencyCombo){a.frequencyCombo.setValue(b);a.showOptions(b);this.innerContainer.items.each(function(c){c.setFrequency(b)})}else{a.on("afterrender",function(){a.frequencyCombo.setValue(b);a.showOptions(b)},a,{single:true})}return a},showOptions:function(c){var b=this,a="day";if(c==="NONE"){b.innerContainer.hide()}else{b.intervalField.show();b.durationField.show();b.innerContainer.show()}switch(c){case"DAILY":case"WEEKDAYS":b.weeklyField.hide();b.monthlyField.hide();b.yearlyField.hide();if(c==="WEEKDAYS"){a="week"}break;case"WEEKLY":b.weeklyField.show();b.monthlyField.hide();b.yearlyField.hide();a="week";break;case"MONTHLY":b.monthlyField.show();b.weeklyField.hide();b.yearlyField.hide();a="month";break;case"YEARLY":b.yearlyField.show();b.weeklyField.hide();b.monthlyField.hide();a="year";break}b.intervalField.updateLabel(a)}});Ext.define("Extensible.form.recurrence.RangeEditPanel",{extend:"Ext.form.Panel",alias:"widget.extensible.recurrence-rangeeditpanel",cls:"extensible-recur-edit-options",headerText:"There are multiple events in this series. How would you like your changes applied?",optionSingleButtonText:"Single",optionSingleDescription:"Apply to this event only. No other events in the series will be affected.",optionFutureButtonText:"Future",optionFutureDescription:"Apply to this and all following events only. Past events will be unaffected.",optionAllButtonText:"All Events",optionAllDescription:"Apply to every event in this series.",editModes:{SINGLE:"single",FUTURE:"future",ALL:"all"},border:false,layout:{type:"vbox",align:"stretch"},initComponent:function(){var a=this;a.editMode=a.editMode||a.editModes.ALL;a.items=[a.getHeaderConfig(),a.getOptionPanelConfig(),a.getSummaryConfig()];a.callParent(arguments)},getHeaderConfig:function(){return{xtype:"component",html:this.headerText,height:55,padding:15}},getSummaryConfig:function(){return{xtype:"component",itemId:this.id+"-summary",html:this.optionAllDescription,flex:1,padding:15}},getOptionPanelConfig:function(){return{xtype:"panel",border:false,layout:{type:"hbox",pack:"center"},items:this.getOptionButtonConfigs()}},getOptionButtonConfigs:function(){var c=this,a={xtype:"button",iconAlign:"top",enableToggle:true,scale:"large",width:80,toggleGroup:"recur-toggle",toggleHandler:c.onToggle,scope:c},b=[Ext.apply({itemId:c.id+"-single",text:c.optionSingleButtonText,iconCls:"recur-edit-single",pressed:c.editMode===c.editModes.SINGLE},a),Ext.apply({itemId:c.id+"-future",text:c.optionFutureButtonText,iconCls:"recur-edit-future",pressed:c.editMode===c.editModes.FUTURE},a),Ext.apply({itemId:c.id+"-all",text:c.optionAllButtonText,iconCls:"recur-edit-all",pressed:c.editMode===c.editModes.ALL},a)];return b},getEditMode:function(){return this.editMode},showEditModes:function(e){e=e||[];var d=this,c=0,b,a=e.length;d.down("#"+d.id+"-single")[a?"hide":"show"]();d.down("#"+d.id+"-future")[a?"hide":"show"]();d.down("#"+d.id+"-all")[a?"hide":"show"]();for(;c<a;c++){b=d.down("#"+d.id+"-"+e[c]);if(b){b.show()}}},onToggle:function(a){var c=this,b=c.getComponent(c.id+"-summary").getEl();if(a.itemId===c.id+"-single"){b.update(c.optionSingleDescription);c.editMode=c.editModes.SINGLE}else{if(a.itemId===c.id+"-future"){b.update(c.optionFutureDescription);c.editMode=c.editModes.FUTURE}else{b.update(c.optionAllDescription);c.editMode=c.editModes.ALL}}}});Ext.define("Extensible.form.recurrence.RangeEditWindow",{extend:"Ext.window.Window",alias:"widget.extensible.recurrence-rangeeditwindow",id:"ext-cal-rangeeditwin",requires:["Extensible.form.recurrence.RangeEditPanel"],title:"Recurring Event Options",width:350,height:240,saveButtonText:"Save",cancelButtonText:"Cancel",closeAction:"hide",modal:true,resizable:false,constrain:true,buttonAlign:"right",layout:"fit",formPanelConfig:{border:false},initComponent:function(){this.items=[{xtype:"extensible.recurrence-rangeeditpanel",itemId:this.id+"-recur-panel"}];this.fbar=this.getFooterBarConfig();this.callParent(arguments)},getRangeEditPanel:function(){return this.down("#"+this.id+"-recur-panel")},prompt:function(a){this.callbackFunction=Ext.bind(a.callback,a.scope||this);this.getRangeEditPanel().showEditModes(a.editModes);this.show()},getFooterBarConfig:function(){var a=["->",{text:this.saveButtonText,itemId:this.id+"-save-btn",disabled:false,handler:this.onSaveAction,scope:this},{text:this.cancelButtonText,itemId:this.id+"-cancel-btn",disabled:false,handler:this.onCancelAction,scope:this}];return a},onSaveAction:function(){var a=this.getComponent(this.id+"-recur-panel").getEditMode();this.callbackFunction(a);this.close()},onCancelAction:function(){this.callbackFunction(false);this.close()}});